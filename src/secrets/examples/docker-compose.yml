# Example Docker Compose configuration for running with vault secrets
#
# The vault password is passed via Docker secrets or environment variable.
# Vault files are mounted from the host.
#
# Usage:
#   # Create the secrets file (DO NOT commit this!)
#   echo "your-vault-password" > .docker-secrets/vault-password
#   chmod 600 .docker-secrets/vault-password
#
#   # Start the server
#   docker-compose up -d

version: '3.8'

services:
  aot-server:
    build: .
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
      - VAULT_ENV=prod
      - LLM_PROVIDER=anthropic
      - PORT=3001
      # Option 1: Read password from file (recommended for production)
      - VAULT_PASSWORD_FILE=/run/secrets/vault-password
      # Option 2: Pass password directly (for development only)
      # - VAULT_PASSWORD=${VAULT_PASSWORD}
    volumes:
      # Mount the vault directory (read-only)
      - ./.vault:/app/.vault:ro
    secrets:
      - vault-password
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3

# Docker secrets (for production use with Swarm or external secret managers)
secrets:
  vault-password:
    # Option 1: File-based secret
    file: ./.docker-secrets/vault-password
    # Option 2: External secret (Docker Swarm, AWS ECS, etc.)
    # external: true

# Example with Kubernetes-style file-based secrets injection
# This writes secrets to a file that the container can read
  aot-server-with-file-secrets:
    build: .
    ports:
      - "3002:3001"
    environment:
      - NODE_ENV=production
      - LLM_PROVIDER=anthropic
      # Tell the app to read secrets from files instead of vault
      - SECRETS_FROM_FILES=true
    volumes:
      # Mount secrets directory where writeSecretsFile output goes
      - ./run-secrets:/run/secrets:ro
    restart: unless-stopped
